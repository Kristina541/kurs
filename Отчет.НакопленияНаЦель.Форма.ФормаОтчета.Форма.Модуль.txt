
&НаСервере
Процедура СформироватьОтчетНаСервере(ТабДок)
	
	Цель = Отчет.Цель;
	
	ОтчетОбъект = РеквизитФормыВЗначение("Отчет");
	Макет = ОтчетОбъект.ПолучитьМакет("Макет");
	ОбластьШапка = Макет.ПолучитьОбласть ("Шапка");
	
	Запрос = ПолучитьЗапрос ();
	Запрос.УстановитьПараметр ("Категория", Цель);
	РезультатЗапроса = Запрос.Выполнить ();
	Если НЕ РезультатЗапроса.Пустой () Тогда
		Выборка = РезультатЗапроса.Выбрать ();
		
		ОбластьСтрока = Макет.ПолучитьОбласть ("ОбластьСтроки");
		
		Пока Выборка.Следующий () Цикл
			
			Сумма = Выборка.Сумма;
			
			Если НЕ ЗначениеЗаполнено (Сумма) Тогда
				Сумма = 0;
			КонецЕсли;
			
			ОбластьСтрока.Параметры ["П1"] = Цель;
			ОбластьСтрока.Параметры ["П2"] =  Цель.НужноНакопить;
			ОбластьСтрока.Параметры ["П3"] = Сумма;
			ОбластьСтрока.Параметры ["П4"] = Цель.НужноНакопить - Сумма;
		КонецЦикла
	КонецЕсли;
	
	ТабДок.Вывести (ОбластьШапка);
	ТабДок.Присоединить (ОбластьСтрока);
	
	
КонецПроцедуры

&НаКлиенте
Процедура СформироватьОтчет(Команда)
	
	
		Если ЗначениеЗаполнено (Отчет.Цель) Тогда
		
		ТабДок = Новый ТабличныйДокумент;
		ТабДок.ТолькоПросмотр = Истина;
		ТабДок.Автомасштаб = Истина;
		ТабДок.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
		
	СформироватьОтчетНаСервере(ТабДок);

		
		ТабДок.Показать ("Отчет ""Коплю на цель""");
		
	Иначе
		Сообщить ("Не выбрана цель");
	КонецЕсли;

	
КонецПроцедуры

Функция ПолучитьЗапрос ()
	
	Запрос = Новый Запрос;
	Запрос.Текст ="ВЫБРАТЬ
	|	СУММА(Расход.Сумма) КАК Сумма
	|ИЗ
	|	Документ.Расход КАК Расход
	|ГДЕ
	|	Расход.Категория = &Категория" ;
	
	Возврат Запрос
	
КонецФункции
